@model tblLopHocPhan

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="row">
    <div class="col-md-11">
        <div class="row ">
            <div class="form-group mb-0 col-md-3">
                @Html.DropDownList("MaNganh3", null, "--Chọn ngành học--", new { @class = "form-control" })
            </div>
            <div class="form-group mb-0 col-md-3">
                @Html.DropDownList("HocPhan3", null, "--Chọn học phần--", new { @class = "form-control " })
            </div>
            <div class="form-group mb-0 col-md-3">
                @Html.DropDownList("NamHoc3", null, "--Chọn năm học--", new { @class = "form-control " })
            </div>
            <div class="form-group mb-0 col-md-3">
                @Html.DropDownList("HocKy3", null, "--Chọn học kỳ--", new { @class = "form-control " })
            </div>
        </div>

    </div>
    <div class="col-md-1 float-right dropleft">
        <button type="button" class="btn btn-info " data-toggle="dropdown">
            <i class="fas fa-bars"></i>
        </button>
        <div class="dropdown-menu dropleft">
            <a class="dropdown-item change-view">Thay đổi dạng xem</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item openAddModal" data-toggle="modal" href="#addModal">Thêm mới lớp học phần</a>
        </div>
    </div>
</div>
<hr />

<div class="LoadAllLopHocPhan">
    @Html.Action("LoadAllLopHocPhan1", "LopHocPhan")
</div>

<!-- The Modal -->
<div class="modal fade" id="addModal">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-info">Thêm mới lớp học phần</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">

                <div class="form-group">
                    @Html.LabelFor(model => model.MaNganh, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.DropDownListFor(model => model.MaNganh, null, "", htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.MaHP, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.DropDownListFor(model => model.MaHP, null, "", htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.TenLHP, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.EditorFor(model => model.TenLHP, new { htmlAttributes = new { @class = "form-control" } })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.MaGV, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.DropDownListFor(model => model.MaGV, null, "", htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.TGBatDau, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.EditorFor(model => model.TGBatDau, new { htmlAttributes = new { @class = "form-control", @type = "date" } })
                        </div>
                    </div>

                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.TGKetThuc, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.EditorFor(model => model.TGKetThuc, new { htmlAttributes = new { @class = "form-control", @type = "date" } })
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.NamHoc, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.EditorFor(model => model.NamHoc, new { htmlAttributes = new { @class = "form-control" } })
                        </div>
                    </div>

                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.HocKy, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.EditorFor(model => model.HocKy, new { htmlAttributes = new { @class = "form-control", @type = "number" } })
                        </div>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <div class="">
                    <button type="button" class="create btn btn-outline-success"><i class="fas fa-plus-circle"></i> Thêm mới</button>
                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="delModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-primary">Thông báo</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <h6 class="text text-warning text-wr">Bạn có muốn xóa lớp học phần này không ?</h6>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <div class="form-actions no-color">
                    <button type="button" value="" data-dismiss="modal" class="Xoa btn btn-outline-danger far fa-trash-alt"> Xóa </button>
                </div>
                <button type="button" class="btn btn-outline-primary" data-dismiss="modal"> Không </button>
            </div>

        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="infModal">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-info">Thông tin học phần</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">
                @Html.Hidden("Id2")
                <div class="form-group">
                    @Html.LabelFor(model => model.MaNganh, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.DropDownList("MaNganh2", null, "", htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.MaHP, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.DropDownList("MaHP2", null, "", htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.TenLHP, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.Editor("TenLHP2", new { htmlAttributes = new { @class = "form-control" } })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.MaGV, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.DropDownList("MaGV2", null, "", htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.TGBatDau, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.TextBox("TGBatDau2", null, "{0:yyyy-MM-dd}", new { @class = "form-control", @type = "date" })
                        </div>
                    </div>

                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.TGKetThuc, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.TextBox("TGKetThuc2", null, "{0:yyyy-MM-dd}", new { @class = "form-control", @type = "date" })
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.NamHoc, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.Editor("NamHoc2", new { htmlAttributes = new { @class = "form-control" } })
                        </div>
                    </div>

                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.HocKy, htmlAttributes: new { @class = "control-label col-md" })
                        <div class="col-md">
                            @Html.Editor("HocKy2", new { htmlAttributes = new { @class = "form-control", @type = "number" } })
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="">
                    <button type="button" class="update btn btn-outline-success"><i class="far fa-edit"></i> Cập nhật</button>
                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Script {


    @*Link script sử dụng table view*@

    <!-- Page level plugins -->
    <script src="~/Assets/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="~/Assets/vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="~/Assets/js/demo/datatables-demo.js"></script>

    <!-- Custom styles for this page -->
    <link href="~/Assets/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $('[data-toggle="tooltip"]').tooltip();

        $(".nav-2").addClass("show");
        var view = 1;
        // Mở modal xóa lớp học phần
        $('body').on('click', '.delete', function () {
            $('#delModal').modal();
            $(".Xoa").val($(this).attr('data-id'));
        });

        // Thêm mới lớp học phần
        $('body').on('click', '.create', function () {
            var formdata = new FormData();
            formdata.append("MaNganh", $("#MaNganh").val());
            formdata.append("MaHP", $("#MaHP").val());
            formdata.append("TenLHP", $("#TenLHP").val());
            formdata.append("MaGV", $("#MaGV").val());
            formdata.append("TGBatDau", $("#TGBatDau").val());
            formdata.append("TGKetThuc", $("#TGKetThuc").val());
            formdata.append("NamHoc", $("#NamHoc").val());
            formdata.append("HocKy", $("#HocKy").val());
            $.ajax({
                async: true,
                url: '@Url.Action("Create", "LopHocPhan")',
                data: formdata,
                contentType: false,
                processData: false,
                dataType: 'json',
                type: 'POST',
                success: function (data) {
                    if (data.status == true) {
                        if (view == 1) {
                            LoadAllLopHocPhan1();
                        }
                        else {
                            LoadAllLopHocPhan2();
                        }
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.success("Thêm mới thành công");
                        $('#addModal').modal('hide');
                        ResetValueAfterAdd();
                    }
                    else {
                        alert(data.status);
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning('Thêm mới không thành công');
                    }
                },
                error: function () {
                    toastr.options.positionClass = "toast-bottom-right";
                    toastr.warning('Thêm mới không thành công');
                }
            });
        });

        // Reset data sau khi add
        function ResetValueAfterAdd() {
            $("#MaNganh").val('');
            $("#MaHP").val('');
            $("#TenLHP").val('');
            $("#MaGV").val('');
            $("#TGBatDau").val('');
            $("#TGKetThuc").val('');
            $("#NamHoc").val('');
            $("#HocKy").val('');
        };

        // Xóa lớp học phần
        $('body').on('click', '.Xoa', function () {
            var Id = $(".Xoa").val();
            $.ajax({
                async: true,
                url: '@Url.Action("Delete", "LopHocPhan")',
                data: { id: Id },
                dataType: 'json',
                type: "POST",
                success: function (data) {
                    if (data.status == true) {
                        if (view == 1) {
                            LoadAllLopHocPhan1();
                        }
                        else {
                            LoadAllLopHocPhan2();
                        }
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.success("Xóa thành công");
                    }
                    if (data.status == false) {
                        alert("Không thể xóa lớp học phần này");
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning("Xóa không thành công");
                    }
                },
                error: function () {
                    toastr.options.positionClass = "toast-bottom-right";
                    toastr.warning('Xóa không thành công');
                }
            });
        });

        // Mở modal thông tin lớp học phần
        $('body').on('click', '.information', function () {
            $('#infModal').modal();
            var MaLHP = $(this).attr('data-id');
            LoadLopHocPhan(MaLHP);
        });

        // Updata lớp học phần
        $(".update").click(function () {
            var formdata = new FormData();
            formdata.append("Id", $("#Id2").val());
            formdata.append("MaNganh", $("#MaNganh2").val());
            formdata.append("MaHP", $("#MaHP2").val());
            formdata.append("TenLHP", $("#TenLHP2").val());
            formdata.append("MaGV", $("#MaGV2").val());
            formdata.append("TGBatDau", $("#TGBatDau2").val());
            formdata.append("TGKetThuc", $("#TGKetThuc2").val());
            formdata.append("NamHoc", $("#NamHoc2").val());
            formdata.append("HocKy", $("#HocKy2").val());
            $.ajax({
                async: true,
                url: '@Url.Action("Edit", "LopHocPhan")',
                contentType: false,
                processData: false,
                data: formdata,
                dataType: 'json',
                type: 'POST',
                success: function (data) {
                    if (data.status == true) {
                        if (view == 1) {
                            LoadAllLopHocPhan1();
                        }
                        else {
                            LoadAllLopHocPhan2();
                        }
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.success("Chỉnh sửa thành công");
                        $('#infModal').modal('hide');
                    }
                    else {
                        alert(data.status);
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning('Chỉnh sửa không thành công');
                    }
                },
                error: function () {
                    toastr.options.positionClass = "toast-bottom-right";
                    toastr.warning('Chỉnh sửa không thành công');
                }

            });
        });

        // Load thông tin lớp học phần
        function LoadLopHocPhan(MaLHP) {
            $.ajax({
                url: '@Url.Action("LoadLopHocPhan", "LopHocPhan")',
                data: { Id: MaLHP },
                dataType: 'json',
                type: 'POST',
                success: function (data) {
                    $.each(data.data, function (index, row) {
                        console.log(row);
                        $("#Id2").val(row.Id);
                        $("#MaNganh2").val(row.MaNganh);
                        $("#MaHP2").val(row.MaHP);
                        $("#TenLHP2").val(row.TenLHP);
                        $("#MaGV2").val(row.MaGV);
                        $("#TGBatDau2").val(row.TGBatDau);
                        $("#TGKetThuc2").val(row.TGKetThuc);
                        $("#NamHoc2").val(row.NamHoc);
                        $("#HocKy2").val(row.HocKy);
                    });
                },
                error: function () {
                    alert("Đã có lỗi xảy ra");
                }
            });
        };

        // Load thông tin tất cả các giảng viên view 1
        function LoadAllLopHocPhan1() {
            $('#dataTable').DataTable().clear();
            $('.LoadAllLopHocPhan').empty();
            $.ajax({
                url: '@Url.Action("LoadAllLopHocPhan1", "LopHocPhan")',
                dataType: 'html',
                type: 'GET',
                success: function (data) {
                    $('.LoadAllLopHocPhan').html(data);
                    $('#dataTable').DataTable().draw();
                    $('[data-toggle="tooltip"]').tooltip();
                },
                error: function () {
                    alert("Đã có lỗi xảy ra");
                },
            });
        };

        // Load thông tin tất cả các giảng viên view 2
        function LoadAllLopHocPhan2() {
            $('#dataTable').DataTable().clear();
            $('.LoadAllLopHocPhan').empty();
            $.ajax({
                url: '@Url.Action("LoadAllLopHocPhan2", "LopHocPhan")',
                dataType: 'html',
                type: 'GET',
                success: function (data) {
                    $('.LoadAllLopHocPhan').html(data);
                },
                error: function () {
                    alert("Đã có lỗi xảy ra");
                },
            });
        };

        // Lọc danh sách lớp học phần
        $('#MaNganh3, #HocPhan3, #NamHoc3, #HocKy3').on('change', function () {
            var MaNganh = $('#MaNganh3').val();
            var HocPhan = $('#HocPhan3').val();
            var NamHoc = $('#NamHoc3').val();
            var HocKy = $('#HocKy3').val();
            if (view == 1) {
                $('#dataTable').DataTable().clear();
                $('.LoadAllLopHocPhan').empty();
                $.ajax({
                    url: '@Url.Action("LoadAllLopHocPhan1", "LopHocPhan")',
                    data: { MaNganh: MaNganh, HocPhan: HocPhan, NamHoc: NamHoc, HocKy: HocKy },
                    dataType: "html",
                    type: 'GET',
                    success: function (data) {
                        $('.LoadAllLopHocPhan').html(data);
                        $('#dataTable').DataTable().draw();
                        $('[data-toggle="tooltip"]').tooltip();
                    },
                    error: function () {
                        alert("Đã có lỗi xảy ra");
                    }
                });
            }
            else {
                $('.LoadAllLopHocPhan').empty();
                $.ajax({
                    url: '@Url.Action("LoadAllLopHocPhan2", "LopHocPhan")',
                    data: { MaNganh: MaNganh, HocPhan: HocPhan, NamHoc: NamHoc, HocKy: HocKy },
                    dataType: 'html',
                    type: 'GET',
                    success: function (data) {
                        $('.LoadAllLopHocPhan').html(data);
                    },
                    error: function () {
                        alert("Đã có lỗi xảy ra");
                    },
                });
            }
        });

        // Thay đổi view
        $('.change-view').on('click', function () {
            var MaNganh = $('#MaNganh3').val();
            var HocPhan = $('#HocPhan3').val();
            var NamHoc = $('#NamHoc3').val();
            var HocKy = $('#HocKy3').val();
            if (view == 2) {
                view = 1;
                $('.LoadAllLopHocPhan').empty();
                $.ajax({
                    url: '@Url.Action("LoadAllLopHocPhan1", "LopHocPhan")',
                    data: { MaNganh: MaNganh, HocPhan: HocPhan, NamHoc: NamHoc, HocKy: HocKy },
                    dataType: "html",
                    type: 'GET',
                    success: function (data) {
                        $('.LoadAllLopHocPhan').html(data);
                        $('#dataTable').DataTable().draw();
                    },
                    error: function () {
                        alert("Đã có lỗi xảy ra");
                    }
                });
            }
            else {
                view = 2;
                $('#dataTable').DataTable().clear();
                $('.LoadAllLopHocPhan').empty();
                $.ajax({
                    url: '@Url.Action("LoadAllLopHocPhan2", "LopHocPhan")',
                    data: { MaNganh: MaNganh, HocPhan: HocPhan, NamHoc: NamHoc, HocKy: HocKy },
                    dataType: 'html',
                    type: 'GET',
                    success: function (data) {
                        $('.LoadAllLopHocPhan').html(data);
                    },
                    error: function () {
                        alert("Đã có lỗi xảy ra");
                    },
                });
            }
        });

        $("#MaNganh").on('change', function () {
            $("#MaGV").empty();
            var MaNganhId = $("#MaNganh").val();
            if (MaNganhId != -1) {
                $.ajax({
                    url: '@Url.Action("LoadGiangVien", "LopHocPhan")',
                    data: { id: MaNganhId },
                    dataType: "json",
                    type: 'GET',
                    success: function (data) {
                        console.log(data.list);
                        var s = '<option value = "- 1"> </option>';
                        $("#MaGV").append(s);
                        $.each(data.list, function (index, row) {
                            $("#MaGV").append("<option value= '" + row.Id + "'> " + row.TenGV + "</option>");
                        });
                    }
                });
            }
        });

        $("#MaNganh2").on('change', function () {
            $("#MaGV2").empty();
            var MaNganhId = $("#MaNganh2").val();
            if (MaNganhId != -1) {
                $.ajax({
                    url: '@Url.Action("LoadGiangVien", "LopHocPhan")',
                    data: { id: MaNganhId },
                    dataType: "json",
                    type: 'GET',
                    success: function (data) {
                        console.log(data.list);
                        var s = '<option value = "- 1"> </option>';
                        $("#MaGV2").append(s);
                        $.each(data.list, function (index, row) {
                            $("#MaGV2").append("<option value= '" + row.Id + "'> " + row.TenGV + "</option>");
                        });
                    }
                });
            }
        });

        $("#MaHP").on('change', function () {
            var TenHP = $("#MaHP option:selected").text();
            $('#TenLHP').val(TenHP);
        });

        $("#MaHP2").on('change', function () {
            var TenHP = $("#MaHP2 option:selected").text();
            $('#TenLHP2').val(TenHP);
        });
    </script>
}