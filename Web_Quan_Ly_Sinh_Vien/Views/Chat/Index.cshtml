@model tblNhomChat

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutSV.cshtml";
}

<div class="card mb-5 shadow">
    <div class="row g-0">
        <div class="col-12 col-lg-5 col-xl-3 border-right">

            <div class="px-4 d-none d-md-block">
                <div class="d-flex align-items-center">
                    <div class="order-0 mr-2">
                        <a class="btn btn-outline-success openModal" data-toggle="modal" data-target="#lstUserModal"><i class="fas fa-plus-circle"></i></a>
                    </div>
                    <div class="flex-grow-1">
                        <input type="text" id="search" class="form-control my-3" placeholder="Search...">
                    </div>
                </div>
            </div>

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active px-2 ml-1 LoadListNguoiNhan" data-toggle="tab" href="#listNguoiNhan"><i class="fas fa-user-friends"></i>Tin nhắn riêng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-2 LoadListNhomChat" data-toggle="tab" href="#listGroup"><i class="fas fa-users"></i>Tin nhắn nhóm</a>
                </li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div id="listNguoiNhan" class="container p-0 tab-pane active">
                    <div class="list-message">
                        @Html.Action("LoadListTinNhanRieng", "Chat")
                    </div>
                </div>
                <div id="listGroup" class="container p-0 tab-pane fade">
                    <div class="list-message2">
                        @Html.Action("LoadListNhomChat", "Chat")
                    </div>
                </div>
            </div>

            <hr class="d-block d-lg-none mt-1 mb-0">
        </div>
        <div class="col-12 col-lg-7 col-xl-9">

            <div class="LoadThongTinTinNhan">

            </div>

            <div class="position-relative">
                <div class="chat-messages p-4 LoadAllTinNhan">



                </div>
            </div>

            <form autocomplete="off" class="chatbox flex-grow-0 pb-3 pt-0 px-4 border-top d-none">
                <ul class="list-file m-0 p-2">
                </ul>
                <div class="input-group">
                    <input type="text" id="message" data-id="" class="form-control" placeholder="Type your message">
                    <label class="btn btn-image border-secondary text-secondary" for="attach"><i class="fa fa-file"></i></label>
                    <input type="file" multiple id="attach">
                    <label class="btn btn-image border-success text-success" for="image"><i class="fas fa-image"></i></label>
                    <input type="file" accept="image/*" multiple id="image">
                    <button class="btn text-primary border-primary" type="submit" data-id="" id="sendmessage"><i class="fa fa-paper-plane"></i></button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="lstUserModal">
    <div class="modal-dialog modal-dialog-centered  modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header row pb-0">
                <div class="col-12 mb-2">
                    <h4 class="modal-title text-info ">Tạo tin nhắn mới</h4>
                </div>
                <div class="form-group col-12">
                    <input class="form-control text-find" type="text" placeholder="Nhập tên để tìm kiếm" />
                </div>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <div id="lstUser">

                </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="find btn btn-outline-success"><i class="fas fa-search"></i> Tìm kiếm</button>
                <button type="button" class="btn btn-outline-danger" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
            </div>

        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="addUserToGroup">
    <div class="modal-dialog modal-dialog-centered  modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header row pb-0">
                <div class="col-12 mb-2">
                    <h4 class="modal-title text-info ">Thêm thành viên vào nhóm chat</h4>
                </div>
                <div class="form-group col-12">
                    <input class="form-control text-find2" data-id="" type="text" placeholder="Nhập tên để tìm kiếm" />
                </div>
                <div class="form-group pl-1">
                    <button type="button" data-id="" class="find2 btn btn-outline-info form-control ml-2"><i class="fas fa-search"></i> Tìm kiếm</button>
                </div>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <div id="lstUserToAddGroup">

                </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" data-id="" class="addUsers btn btn-outline-success"><i class="fas fa-user-plus"></i> Thêm vào nhóm</button>
                <button type="button" class="btn btn-outline-danger" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
            </div>

        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="listUserInGroup">
    <div class="modal-dialog modal-dialog-centered  modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header row pb-0">
                <div class="col-12 mb-2">
                    <h4 class="modal-title text-info ">Danh sách thành viên trong nhóm chat</h4>
                </div>
                <div class="form-group col-12">
                    <input class="form-control text-find3" data-id="" type="text" placeholder="Nhập tên để tìm kiếm" />
                </div>
                <div class="form-group pl-1">
                    <button type="button" data-id="" class="find3 btn btn-outline-info form-control ml-2"><i class="fas fa-search"></i> Tìm kiếm</button>
                </div>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <div id="LoadUserInGroup">

                </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" data-id="" class="deleteUser btn btn-outline-danger"><i class="fas fa-user-slash"></i> Xóa khỏi nhóm</button>
                <button type="button" class="btn btn-outline-primary" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
            </div>

        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="addModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-info">Tạo nhóm chat</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">

                <div class="form-group">
                    @Html.LabelFor(model => model.TenNhom, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.EditorFor(model => model.TenNhom, new { htmlAttributes = new { @class = "form-control", @Required = "" } })
                        @Html.ValidationMessageFor(model => model.TenNhom, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.Avatar, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        <div class="card border-info shadow-sm">
                            <div class="card-header">Cập nhật hình ảnh nhóm</div>
                            <div class="card-body">
                                <div class="text-center">
                                    <img style="width: 200px; height:200px;" src="~/Images/NhomChat/avatar.png" class="avatar  img-thumbnail " alt="avatar">
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="custom-file">
                                    <input type="file" name="ImageFile" id="customFile" class="text-center center-block file-upload custom-file-input">
                                    <label class="custom-file-label loadtext" for="customFile">Chọn file</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <div class="">
                    <button type="button" class="create btn btn-outline-success"><i class="fas fa-plus-circle"></i> Thêm mới</button>
                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="infoGroup">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-info">Thông tin nhóm chat</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">
                @Html.Hidden("Id2")
                <div class="form-group">
                    @Html.LabelFor(model => model.TenNhom, htmlAttributes: new { @class = "control-label col-md" })
                    <div class="col-md">
                        @Html.Editor("TenNhom2", new { htmlAttributes = new { @class = "form-control", @Required = "" } })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.Avatar, htmlAttributes: new { @class = "control-label col-md" })
                    @Html.Hidden("Avatar2")
                    <div class="col-md">
                        <div class="card border-info shadow-sm">
                            <div class="card-header">Cập nhật hình ảnh cho giảng viên</div>
                            <div class="card-body">
                                <div class="text-center">
                                    <img style="width: 200px; height:200px;" src="" class="avatar2  img-thumbnail " alt="avatar" />
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="custom-file">
                                    <input type="file" name="ImageFile" id="customFile2" class="text-center center-block file-upload2 custom-file-input">
                                    <label class="custom-file-label loadtext2" for="customFile2">Chọn file</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <div class="">
                    <button type="button" class="update btn btn-outline-success"><i class="far fa-edit"></i> Cập nhật</button>
                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="delGroup">
    <div class="modal-dialog modal-dialog-centered ">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-info">Thông báo</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <h6 class="text text-warning text-wr">Bạn có muốn xóa nhóm chat này không ?</h6>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <div class="form-actions no-color">
                    <button type="button" value="" data-dismiss="modal" class="Xoa1 btn btn-outline-danger far fa-trash-alt"> Xóa </button>
                </div>
                <button type="button" class="btn btn-outline-primary" data-dismiss="modal"> Không </button>
            </div>

        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="delMsg">
    <div class="modal-dialog modal-dialog-centered ">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-info">Thông báo</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <h6 class="text text-warning text-wr">Bạn có muốn xóa cuộc trò chuyện này không ?</h6>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <div class="form-actions no-color">
                    <button type="button" value="" data-dismiss="modal" class="Xoa2 btn btn-outline-danger far fa-trash-alt"> Xóa </button>
                </div>
                <button type="button" class="btn btn-outline-primary" data-dismiss="modal"> Không </button>
            </div>

        </div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="leaveGroup">
    <div class="modal-dialog modal-dialog-centered ">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-primary">Thông báo</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <h6 class="text text-warning text-wr">Bạn có muốn rời khỏi nhóm chat này không ?</h6>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <div class="form-actions no-color">
                    <button type="button" value="" data-dismiss="modal" class="leave btn btn-outline-danger"><i class="fas fa-running"></i> Rời khỏi </button>
                </div>
                <button type="button" class="btn btn-outline-primary" data-dismiss="modal"> Không </button>
            </div>

        </div>
    </div>
</div>

<style>
    .message-img {
        max-width: 20rem;
        max-height: 20rem;
        margin-right: .5rem;
    }

        .message-img img {
            width: 100%;
            height: 100%;
        }

    .list-file {
        width: 100%;
        background: var(--txtColorSecond);
        left: 0;
        bottom: 100%;
        display: flex;
        overflow-y: auto;
        box-sizing: border-box;
    }

        .list-file.active {
            padding: 1rem;
        }

        .list-file img {
            width: 5rem;
            height: 5rem;
            object-fit: cover;
            margin: 0 .5rem;
        }

        .list-file li {
            position: relative;
            list-style-type: none;
        }

    .file-input {
        padding: 0.5rem;
        color: var(--txtBlack);
        box-shadow: 0rem .2rem .4rem rgba(1, 1, 1, 0.1);
        margin-right: .5rem;
        white-space: nowrap;
    }

    .delete-attach {
        position: absolute;
        right: -.2rem;
        top: -.2rem;
        color: blue;
        cursor: pointer;
        width: 2rem;
        height: 2rem;
        font-size: 1.4rem;
        text-align: center;
        line-height: 2rem;
        background: var(--mainColor);
        opacity: .5;
        border-radius: 50%;
    }

    .chatbox .btn {
        background: transparent;
        color: var(--btnColor);
        width: auto;
        margin: 0rem;
    }

    .chatbox input[type="file"], .register-form input[type="file"] {
        display: none;
    }

    .chat-online {
        color: #34ce57
    }

    .chat-offline {
        color: #e4606d
    }

    .chat-messages {
        display: flex;
        flex-direction: column;
        height: 510px;
        max-height: 510px;
        overflow-y: scroll;
    }

    .list-message {
        display: flex;
        flex-direction: column;
        max-height: 550px;
        overflow-y: scroll;
    }

    .list-message2 {
        display: flex;
        flex-direction: column;
        max-height: 550px;
        overflow-y: scroll;
    }

    .chat-message-left,
    .chat-message-right {
        display: flex;
        flex-shrink: 0
    }

    .chat-message-left {
        margin-right: auto
    }

    .chat-message-right {
        flex-direction: row-reverse;
        margin-left: auto
    }

    .py-3 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
    }

    .px-4 {
        padding-right: 1.5rem !important;
        padding-left: 1.5rem !important;
    }

    .flex-grow-0 {
        flex-grow: 0 !important;
    }

    .border-top {
        border-top: 1px solid #dee2e6 !important;
    }

    /* width */
    ::-webkit-scrollbar {
        width: 10px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
        background: #888;
    }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
</style>

@section Script {

    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="~/Scripts/Chat.js"></script>
    @*<script>
            var imageUser = $('.img-profile').attr('src');
            var isNhom = false;
            var isChatNhom = false;
            var groupname = '';

            // Mở modal tìm kiếm người dùng để thêm vào nhóm
            $('body').on('click', '.openModalAddUserToGroup', function () {
                var Id = $(this).attr('data-id');
                $('#addUserToGroup').modal('show');
                $('#lstUserToAddGroup').empty();
                $('.find2').attr('data-id', Id);
                $('.addUsers').attr('data-id', Id);
                $('.text-find2').val('');
            });

            // Mở modal xem danh sách thành viên trong nhóm
            $('body').on('click', '.openModalListUserInGroup', function () {
                var Id = $(this).attr('data-id');
                if ($(this).attr('is-admin') == 1) {
                    $('.deleteUser').show();
                }
                else {
                    $('.deleteUser').hide();
                }
                $('#listUserInGroup').modal('show');
                LoadUserInGroup(Id);
                $('.find3').attr('data-id', Id);
                $('.deleteUser').attr('data-id', Id);
                $('.text-find3').val('');
            });

            // Mở modal xóa nhóm chat
            $('body').on('click', '.openModalDeleteGroup', function () {
                $('#delGroup').modal('show');
                $('.Xoa1').val($(this).attr('data-id'));
            });

            // Mở modal xóa cuộc trò chuyện
            $('body').on('click', '.openModalDeleteMsg', function () {
                $('#delMsg').modal('show');
                $('.Xoa2').val($(this).attr('data-id'));
            });

            // Mở modal rời khỏi nhóm chat
            $('body').on('click', '.openModalLeaveGroup', function () {
                $('#leaveGroup').modal('show');
                $('.leave').val($(this).attr('data-id'));
            });

            // Xóa tin nhắn riêng
            $('body').on('click', '.Xoa2', function () {
                var Id = $(".Xoa2").val();
                $.ajax({
                    async: true,
                    url: '@Url.Action("DeleteMsg", "Chat")',
                    data: { Id: Id },
                    dataType: 'json',
                    type: "POST",
                    success: function (data) {
                        if (data.status == true) {
                            LoadListNguoiNhan();
                            $('.LoadAllTinNhan').empty();
                            $('.LoadThongTinTinNhan').empty();
                            $('.chatbox').addClass('d-none');
                            $('#message').attr('data-id', '');
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.success("Xóa thành công");
                        }
                    },
                    error: function () {
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning('Xóa không thành công');
                    }
                });
            });

            // Rời khỏi nhóm chat
            $('body').on('click', '.leave', function () {
                var Id = $(".leave").val();
                $.ajax({
                    async: true,
                    url: '@Url.Action("LeaveGroupChat", "Chat")',
                    data: { Id: Id },
                    dataType: 'json',
                    type: "POST",
                    success: function (data) {
                        if (data.status == true) {
                            LoadListNhomChat();
                            $('.LoadAllTinNhan').empty();
                            $('.LoadThongTinTinNhan').empty();
                            $('.chatbox').addClass('d-none');
                            $('#message').attr('data-id', '');
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.success("Rời nhóm thành công");
                        }
                        if (data.status == false) {
                            alert("Không thể xóa giảng viên này");
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.warning("Rời nhóm không thành công");
                        }
                    },
                    error: function () {
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning('Xóa không thành công');
                    }
                });
            });

            // Xóa nhóm chat
            $('body').on('click', '.Xoa1', function () {
                var Id = $(".Xoa1").val();
                $.ajax({
                    async: true,
                    url: '@Url.Action("DeleteGroupChat", "Chat")',
                    data: { Id: Id },
                    dataType: 'json',
                    type: "POST",
                    success: function (data) {
                        if (data.status == true) {
                            LoadListNhomChat();
                            $('.LoadAllTinNhan').empty();
                            $('.LoadThongTinTinNhan').empty();
                            $('.chatbox').addClass('d-none');
                            $('#message').attr('data-id', '');
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.success("Xóa thành công");
                        }
                    },
                    error: function () {
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning('Xóa không thành công');
                    }
                });
            });

            // Tìm kiếm người dùng để thêm vào nhóm
            $('.find2').on('click', function () {
                var Id = $(this).attr('data-id');
                var s = $('.text-find2').val();
                if (s.trim() == '' || s == null) {
                    alert("Vui lòng nhập mã hoặc tên để tìm kiếm");
                    $('.text-find2').val('').focus();
                    return;
                }
                GetUsersToAddGroup(Id, s);
            });

            // Tìm kiếm người trong nhóm chat
            $('.find3').on('click', function () {
                var Id = $(this).attr('data-id');
                var s = $('.text-find3').val();
                LoadUserInGroup(Id, s);
            });

            // Hàm load user trong nhóm
            function LoadUserInGroup(Id, s) {
                $.ajax({
                    url: '@Url.Action("LoadUserInGroup", "Chat")',
                    data: { Id: Id, s: s},
                    type: 'GET',
                    dataType: 'html',
                    success: function (data) {
                        $('#LoadUserInGroup').empty();
                        $('#LoadUserInGroup').html(data);
                    }
                });
            }

            // Hàm load user để thêm vào nhóm
            function GetUsersToAddGroup(Id, s) {
                $.ajax({
                    url: '@Url.Action("GetUsersToAddGroup", "Chat")',
                    data: { Id: Id, s: s },
                    dataType: 'html',
                    type: 'GET',
                    success: function (data) {
                        $("#lstUserToAddGroup").empty();
                        $("#lstUserToAddGroup").append(data);
                    }
                });
            };

            // Thêm người dùng vào nhóm chat
            $('.addUsers').on('click', function () {
                var Id = $(this).attr('data-id');
                var s = $('.text-find2').val();
                var selected = [];
                $('#lstUserToAddGroup input:checked').each(function () {
                    selected.push($(this).attr('id'));
                });
                $.ajax({
                    url: '@Url.Action("AddUserToGroup", "Chat")',
                    type: 'POST',
                    dataType: 'json',
                    data: { Id: Id, UserId: selected },
                    async: true,
                    success: function (data) {
                        if (data.status == true) {
                            GetUsersToAddGroup(Id, s);
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.success("Thêm mới thành công");
                        }
                    }
                });
            });

            // Xóa người dùng khỏi nhóm chat
            $('.deleteUser').on('click', function () {
                var Id = $(this).attr('data-id');
                var s = $('.text-find3').val();
                var selected = [];
                $('#LoadUserInGroup input:checked').each(function () {
                    selected.push($(this).attr('id'));
                });
                $.ajax({
                    url: '@Url.Action("DeleteUserFromGroup", "Chat")',
                    type: 'POST',
                    dataType: 'json',
                    data: { Id: Id, UserId: selected },
                    async: true,
                    success: function (data) {
                        if (data.status == true) {
                            LoadUserInGroup(Id, s);
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.success("Xóa thành công");
                        }
                    }
                });
            });

            $("#search").on("keyup", function () {
                var value = $(this).val().trim().toLowerCase();
                //if (value != "") {
                //    $('#search').addClass("active");
                //}
                //else {
                //    $('#search').removeClass("active");
                //}
                if (isNhom == false) {
                    $("#listMessage li").filter(function () {
                        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                    });
                }
                else if (isNhom == true) {
                    $("#listMessage2 li").filter(function () {
                        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                    });
                }
            });

            // Mở modal thông tin nhóm chat
            $('body').on('click', '.openModalInforGroup', function () {
                var Id = $(this).attr('data-id');
                $.ajax({
                    url: '@Url.Action("LoadInfoNhom", "Chat")',
                    data: { Id: Id },
                    dataType: 'json',
                    type: 'GET',
                    success: function (data) {
                        $.each(data.data, function (index, row) {
                            $("#Id2").val(row.Id);
                            $("#TenNhom2").val(row.TenNhom);
                            $("#Ten2").val(row.Ten);
                            $(".avatar2").attr('src', row.Avatar);
                            $("#Avatar2").val(row.Avatar);
                            $(".loadtext2").html(row.Avatar.split('/').pop());
                        });
                    }
                });
                $('#infoGroup').modal('show');
            });

            //setInterval(() => {
            //    if (!$('#search').hasClass('active') && isNhom == false) {
            //        LoadListNguoiNhan();
            //    }
            //    else if(!$('#search').hasClass('active') && isNhom == true){
            //        LoadListNhomChat();
            //    }
            //}, 5000);

            // Create nhóm chat
            $('body').on('click', '.create', function () {
                var formdata = new FormData();
                formdata.append("TenNhom", $("#TenNhom").val());
                formdata.append("ImageFile", $("#customFile").get(0).files[0]);
                if ($("#TenNhom").val().trim() == '') {
                    alert('Vui lòng nhập tên nhóm');
                    $("#TenNhom").val('');
                    $("#TenNhom").focus();
                }
                $.ajax({
                    async: true,
                    url: '@Url.Action("CreateNhomChat", "Chat")',
                    data: formdata,
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    type: 'POST',
                    success: function (data) {
                        if (data.status == true) {
                            LoadListNhomChat();
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.success("Thêm mới thành công");
                            $('#addModal').modal('hide');
                            $("#TenNhom").val('');
                            $("#customFile").val('');
                            $('.avatar').attr('src', "/Images/NhomChat/avatar.png");
                            $(".loadtext").html("Chọn file");
                        }
                        else {
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.warning('Thêm mới không thành công');
                        }
                    },
                    error: function () {
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning('Thêm mới không thành công');
                    }
                });
            });

            // Update thông tin nhóm chat
            $(".update").click(function () {
                var formdata = new FormData();
                formdata.append("Id", $("#Id2").val());
                formdata.append("TenNhom", $("#TenNhom2").val());
                formdata.append("Avatar", $("#Avatar2").val());
                formdata.append("ImageFile", $("#customFile2").get(0).files[0]);
                $.ajax({
                    async: true,
                    url: '@Url.Action("UpdateThongTinNhom", "Chat")',
                    contentType: false,
                    processData: false,
                    data: formdata,
                    dataType: 'json',
                    type: 'POST',
                    success: function (data) {
                        if (data.status == true) {
                            $.ajax({
                                url: '@Url.Action("LoadThongTinNhom", "Chat")',
                                data: { id: $("#Id2").val() },
                                dataType: 'html',
                                type: 'GET',
                                success: function (data) {
                                    $('.LoadThongTinTinNhan').html(data);
                                }
                            });
                            LoadListNhomChat();
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.success("Chỉnh sửa thành công");
                            $('#infoGroup').modal('hide');
                        }
                        else {
                            alert(data.status);
                            toastr.options.positionClass = "toast-bottom-right";
                            toastr.warning('Chỉnh sửa không thành công');
                        }
                    },
                    error: function () {
                        toastr.options.positionClass = "toast-bottom-right";
                        toastr.warning('Chỉnh sửa không thành công');
                    }
                });
            });

            // Load danh sách người nhận
            $('body').on('click', '.LoadListNguoiNhan', function () {
                isNhom = false;
                $('.openModal').attr('data-target', '#lstUserModal');
                LoadListNguoiNhan();
            });

            // Load danh sách nhóm chat
            $('body').on('click', '.LoadListNhomChat', function () {
                isNhom = true;
                $('.openModal').attr('data-target', '#addModal');
                LoadListNhomChat();
            });

            $(function () {
                var chat = $.connection.chatHub;

                chat.client.ThongBaoOnline = function (Id) {
                    if (isNhom == false) {
                        $('#listMessage').find('.user-' + Id).removeClass('chat-offline').addClass('chat-online');
                    }
                };

                chat.client.ThongBaoOffline = function (Id) {
                    if (isNhom == false) {
                        $('#listMessage').find('.user-' + Id).removeClass('chat-online').addClass('chat-offline');
                    }
                };

                chat.client.ThongBaoUpdateThongTinNhom = function (GroupId, status) {
                    if (GroupId == $('#message').attr('data-id') && status == true && isChatNhom == true) {
                        LoadListNhomChat();
                        $.ajax({
                            url: '@Url.Action("LoadThongTinNhom", "Chat")',
                            data: { id: GroupId },
                            dataType: 'html',
                            type: 'GET',
                            success: function (data) {
                                $('.LoadThongTinTinNhan').html(data);
                            }
                        });
                    }
                    else {
                        LoadListNhomChat();
                    }
                };

                chat.client.message = function (fromUser, message) {
                    if (fromUser == $('#message').attr('data-id') && isChatNhom == false) {
                        $('.chat-messages').append(message);
                        LoadListNguoiNhan();
                    }
                    else if (isNhom == false)
                    {
                        LoadListNguoiNhan();
                    }
                };

                chat.client.ThongBaoAddVaoNhom = function (status) {
                    if (status == true) {
                        LoadListNhomChat();
                    }
                };

                chat.client.ThongBaoXoaTinNhan = function (userId, status) {
                    if (userId == $('#message').attr('data-id') && status == true && isChatNhom == false) {
                        LoadListNguoiNhan();
                        $('.LoadAllTinNhan').empty();
                        $('.LoadThongTinTinNhan').empty();
                        $('.chatbox').addClass('d-none');
                        $('#message').attr('data-id', '');
                    }
                    else {
                        LoadListNguoiNhan();
                    }
                };

                chat.client.ThongBaoBiKickKhoiNhom = function (Group, status) {
                    if (Group == $('#message').attr('data-id') && status == true) {
                        LoadListNhomChat();
                        $('.LoadAllTinNhan').empty();
                        $('.LoadThongTinTinNhan').empty();
                        $('.chatbox').addClass('d-none');
                        $('#message').attr('data-id', '');
                    }
                    else {
                        LoadListNhomChat();
                    }
                };

                chat.client.ThongBaoXoaNhomChat = function (Group, status) {
                    if (Group == $('#message').attr('data-id') && status == true) {
                        LoadListNhomChat();
                        $('.LoadAllTinNhan').empty();
                        $('.LoadThongTinTinNhan').empty();
                        $('.chatbox').addClass('d-none');
                        $('#message').attr('data-id', '');
                    }
                    else {
                        LoadListNhomChat();
                    }
                };

                chat.client.messageGroup = function (fromUser, message) {
                    if (fromUser == $('#message').attr('data-id') && isChatNhom == true) {
                        $('.chat-messages').append(message);
                        LoadListNhomChat();
                    }
                    else if (isNhom == true) {
                        LoadListNhomChat();
                    }
                };

                // Set initial focus to message input box.
                $('#message').focus();

                // Start the connection.
                $.connection.hub.start().done(function () {

                    $('body').on('click', '.connect', function () {
                        var btn = $(this);
                        isChatNhom = false;
                        $('#message').attr('data-id', btn.attr('data-id'));
                        $('#sendmessage').attr('data-id', btn.attr('data-id'));
                        LoadThongTinTinNhan(btn.attr('data-id'));
                    });

                    $('body').on('click', '.connect2', function () {
                        var btn = $(this);
                        isChatNhom = true;
                        //if (groupname != '') {
                        //    chat.server.remove(groupname);
                        //}
                        //groupname = btn.attr('data-id');
                        //chat.server.join(groupname);
                        $('#message').attr('data-id', btn.attr('data-id'));
                        $('#sendmessage').attr('data-id', btn.attr('data-id'));
                        LoadThongTinTinNhan(btn.attr('data-id'));
                    });

                });
            });

            function SendMessage(element, e) {
                let message = $(element).val();
                let toUserId = $(element).attr('data-id');
                if (e.which === 13) {
                    $.ajax({
                        url: '@Url.Action("SendMessage", "Chat")',
                        type: 'POST',
                        dataType: 'html',
                        data: { toUserId: toUserId, message: message, isChatNhom: isChatNhom },
                        async: true,
                        success: function (data) {
                            $('.LoadAllTinNhan').append(data);
                            $(element).val('').focus();
                        },
                        complete: function () {
                            if (isChatNhom == true) {
                                LoadListNhomChat();
                            }
                            else {
                                LoadListNguoiNhan();
                            }
                        }
                    });
                };
            }

            // Khi modal tìm kiếm người dùng được hiện lên
            $("#lstUserModal").on('show.bs.modal', function () {
                $("#lstUser").empty();
                $('.text-find').val('');
            });

            // Tìm kiếm người dùng để tạo tin nhắn mới
            $('.find').on('click', function () {
                var s = $('.text-find').val();
                if (s.trim() == '' || s == null) {
                    alert("Vui lòng nhập mã hoặc tên để tìm kiếm");
                    $('.text-find').val('').focus();
                    return;
                }
                $.ajax({
                    url: '@Url.Action("GetUsers", "Chat")',
                    data: { s: s },
                    dataType: 'html',
                    type: 'GET',
                    success: function (data) {
                        $("#lstUser").empty();
                        $("#lstUser").append(data);
                    }
                });
            });

            // Tạo tin nhắn riêng mới
            $('body').on('dblclick', '.create-msg', function () {
                var id = $(this).attr('data-id');
                $('#message').attr('data-id', id);
                $('#sendmessage').attr('data-id', id);
                isChatNhom = false;
                LoadThongTinTinNhan(id);
                $('#lstUserModal').modal('hide');
            });

            // Load thông tin tin nhắn và các tin nhắn
            function LoadThongTinTinNhan(id) {
                if (isChatNhom == false) {
                    $.ajax({
                        url: '@Url.Action("LoadThongTinTinNhan","Chat")',
                        data: { id: id },
                        dataType: 'html',
                        type: 'GET',
                        success: function (data) {
                            $('.LoadThongTinTinNhan').html(data);
                        }
                    });
                    $.ajax({
                        url: '@Url.Action("LoadAllTinNhanRieng","Chat")',
                        data: { id: id },
                        dataType: 'html',
                        type: 'GET',
                        success: function (data) {
                            $('.LoadAllTinNhan').html(data);
                        }
                    });
                    $('.chatbox').removeClass('d-none');
                    $('#lstUserModal').modal('hide');
                }
                else {
                    $.ajax({
                    url: '@Url.Action("LoadThongTinNhom", "Chat")',
                    data: { id: id },
                    dataType: 'html',
                    type: 'GET',
                    success: function (data) {
                        $('.LoadThongTinTinNhan').html(data);
                    }
                    });
                    $.ajax({
                        url: '@Url.Action("LoadAllTinNhanNhom", "Chat")',
                        data: { id: id },
                        dataType: 'html',
                        type: 'GET',
                        success: function (data) {
                            $('.LoadAllTinNhan').html(data);
                        }
                    });
                    $('.chatbox').removeClass('d-none');
                    $('#lstUserModal').modal('hide');
                }
            };

            function LoadListNhomChat() {
                $.ajax({
                    url: '@Url.Action("LoadListNhomChat", "Chat")',
                    type: 'GET',
                    dataType: 'html',
                    success: function (data) {
                        $('.list-message2').html(data);
                    }
                });
            };

            function LoadListNguoiNhan() {
                $.ajax({
                        url: '@Url.Action("LoadListTinNhanRieng", "Chat")',
                        type: 'GET',
                        dataType: 'html',
                        success: function (data) {
                            $('.list-message').html(data);
                        }
                    });
            };

            // Tự động scroll xuống cuối trang
            $('body').on('DOMSubtreeModified', '.chat-messages', function () {
                $('.chat-messages')[0].scrollTop = $('.chat-messages')[0].scrollHeight;
            });

            $('.chat-messages')[0].scrollTop = $('.chat-messages')[0].scrollHeight;
        </script>*@

    <script>
        var attachFile = document.getElementById("attach");
        var imageFile = document.getElementById("image");
        var file = document.querySelector(".list-file");
        var listFile = [];
        var typeFile = "image";
        var deleteAttach = document.querySelectorAll(".delete-attach");

        function setDeleteAttach() {
            deleteAttach = document.querySelectorAll(".delete-attach");

        }

        function renderFile(typeFile) {
            let listFileHTML = "";
            let idx = 0;

            if (typeFile == "image") {
                for (const file of listFile) {
                    listFileHTML += '<li><img src="' + URL.createObjectURL(file) + '" alt="Image file"><span data-idx="' + (idx) + '" onclick="deleteFile(' + idx + ')" class="delete-attach">X</span></li>';
                    idx++;
                }
            } else {
                for (const file of listFile) {
                    listFileHTML += '<li><div class="file-input">' + file.name + '</div><span data-idx="' + (idx) + '" onclick="deleteFile(' + idx + ')" class="delete-attach">X</span></li>';
                    idx++;
                }
            }

            $('#message').focus();
            if (listFile.length == 0) {
                file.innerHTML = "";
                file.classList.remove("active");
            } else {
                file.innerHTML = listFileHTML;
                file.classList.add("active");
            }

            deleteAttach = document.querySelectorAll(".delete-attach");
        }

        attachFile.addEventListener("change", function (e) {
            let filesInput = e.target.files;

            for (const file of filesInput) {
                listFile.push(file);
            }

            typeFile = "file";
            renderFile("attach");

            this.value = null;
        });

        imageFile.addEventListener("change", function (e) {
            let filesImage = e.target.files;

            for (const file of filesImage) {
                listFile.push(file);
                console.log(file);
            }

            typeFile = "image";

            renderFile("image");

            this.value = null;
        });


        function deleteFile(idx) {
            if (!isNaN(idx)) listFile.splice(idx, 1);
            renderFile(typeFile);
        }
    </script>

    <script type="text/javascript">
        $(document).ready(function () {
            $.connection.chatHub.client.uploadfile = function (fromUser, message) {
                if (fromUser == $('#message').attr('data-id') && isChatNhom == false) {
                    $('.chat-messages').append(message);
                    LoadListNguoiNhan();
                }
                else if (isNhom == false) {
                    LoadListNguoiNhan();
                }
            };

            $('.chatbox').submit(function (e) {
                let message = $('#message').val();
                let toUserId = $('#message').attr('data-id');
                if (message.trim() != '') {
                    $.ajax({
                        url: '/Chat/SendMessage',
                        type: 'POST',
                        dataType: 'html',
                        data: { toUserId: toUserId, message: message, isChatNhom: isChatNhom },
                        async: true,
                        success: function (data) {
                            $('.LoadAllTinNhan').append(data);
                            $('#message').val('').focus();
                        },
                        complete: function () {
                            if (isChatNhom == true) {
                                LoadListNhomChat();
                            }
                            else {
                                LoadListNguoiNhan();
                            }
                        }
                    });
                }
                if (listFile.length > 0) {
                    var formData = new FormData();
                    formData.append("toUserId", toUserId);
                    formData.append("isChatNhom", isChatNhom);
                    for (i = 0; i < listFile.length; i++) {
                        formData.append(listFile[i].name, listFile[i]);
                    }
                    $.ajax({
                        url: '/Chat/UploadFiles',
                        type: 'POST',
                        dataType: 'html',
                        data: formData,
                        contentType: false,
                        processData: false,
                        async: true,
                        success: function (data) {
                            $('.LoadAllTinNhan').append(data);
                            $('#message').val('').focus();
                            listFile = [];
                            renderFile();
                        },
                        complete: function () {
                            if (isChatNhom == true) {
                                LoadListNhomChat();
                            }
                            else {
                                LoadListNguoiNhan();
                            }
                        }
                    });
                }
                e.preventDefault();
            });

            $(".custom-file-input").on("change", function () {
                var fileName = $(this).val().split("\\").pop();
                $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
            });

            var readURL = function (input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $('.avatar').attr('src', e.target.result);
                    }

                    reader.readAsDataURL(input.files[0]);
                }
            }

            $(".file-upload").on('change', function () {
                readURL(this);
            });

            var readURL2 = function (input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $('.avatar2').attr('src', e.target.result);
                    }

                    reader.readAsDataURL(input.files[0]);
                }
            }


            $(".file-upload2").on('change', function () {
                readURL2(this);
            });
        });
    </script>


}