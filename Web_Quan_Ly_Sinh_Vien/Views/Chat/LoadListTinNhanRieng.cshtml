@model IEnumerable<tblFriend>

@{
    List<Nullable<long>> NguoiNhan = new List<Nullable<long>>();
    long user = long.Parse(User.Identity.Name);
}

<ul class="list-group" id="listMessage">
    @{
        foreach (var item in Model)
        {
            if (item.NguoiGui == user && NguoiNhan.Contains(item.NguoiNhan) == false)
            {
                NguoiNhan.Add(item.NguoiNhan);
                <li class="border-left-info mb-1">
                    <a href="#" data-id="@item.NguoiNhan" class="connect list-group-item list-group-item-action border-0">
                        @*<div class="badge bg-success float-right">5</div>*@
                        <div class="d-flex align-items-start">
                            <img src="@Url.Content(item.tblUser1.Anh)" class="rounded-circle mr-1" alt="Vanessa Tucker" width="40" height="40">
                            <div class="flex-grow-1 ml-3">
                                <strong>@item.tblUser1.Ho @item.tblUser1.Ten</strong>
                                @{
                                    if (@item.tblUser1.ConnectionId != null)
                                    {
                                        <div class="small float-right"><span class="fas fa-circle user-@item.tblUser1.Id chat-online"></span> @*Online*@</div>
                                    }
                                    else
                                    {
                                        <div class="small float-right"><span class="fas fa-circle user-@item.tblUser1.Id chat-offline"></span> @*Offline*@</div>
                                    }
                                }
                                <div class="small">
                                    @{
                                        if (item.LastMsg != null)
                                        {
                                            if (item.tblTinNhan.NguoiGui == user)
                                            {
                                                <span>Bạn: </span>
                                            }
                                            if (item.tblTinNhan.LoaiTinNhan == 2 || item.tblTinNhan.LoaiTinNhan == 3)
                                            {
                                                var s = item.tblTinNhan.NoiDung.Split('/').LastOrDefault();
                                                if (s.Length >= 20)
                                                {
                                                    <span>@s.Substring(0, 17)...</span>
                                                }
                                                else
                                                {
                                                    <span>@s</span>
                                                }

                                            }
                                            else
                                            {
                                                if (item.tblTinNhan.NoiDung.Length >= 20)
                                                {
                                                    <span>@item.tblTinNhan.NoiDung.Substring(0, 17)...</span>
                                                }
                                                else
                                                {
                                                    @item.tblTinNhan.NoiDung
                                                }
                                            }
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </a>
                </li>
            }
            else if (item.NguoiGui != user && NguoiNhan.Contains(item.NguoiGui) == false)
            {
                NguoiNhan.Add(item.NguoiGui);
                <li class="border-left-info mb-1">
                    <a href="#" data-id="@item.NguoiGui" class="connect list-group-item list-group-item-action border-0">
                        @*<div class="badge bg-success float-right">5</div>*@
                        <div class="d-flex align-items-start">
                            <img src="@Url.Content(item.tblUser.Anh)" class="rounded-circle mr-1" alt="Vanessa Tucker" width="40" height="40">
                            <div class="flex-grow-1 ml-3">
                                <strong>@item.tblUser.Ho @item.tblUser.Ten</strong>
                                @{
                                    if (@item.tblUser.ConnectionId != null)
                                    {
                                        <div class="small float-right"><span class="fas fa-circle user-@item.tblUser.Id chat-online"></span> @*Online*@</div>
                                    }
                                    else
                                    {
                                        <div class="small float-right"><span class="fas fa-circle user-@item.tblUser.Id chat-offline"></span> @*Offline*@</div>
                                    }
                                }
                                <div class="small">
                                    @{
                                        if (item.LastMsg != null)
                                        {
                                            if (item.tblTinNhan.NguoiGui == user)
                                            {
                                                <span>Bạn: </span>
                                            }
                                            if (item.tblTinNhan.LoaiTinNhan == 2 || item.tblTinNhan.LoaiTinNhan == 3)
                                            {
                                                var s = item.tblTinNhan.NoiDung.Split('/').LastOrDefault();
                                                if (s.Length >= 20)
                                                {
                                                    <span>@s.Substring(0, 17)...</span>
                                                }
                                                else
                                                {
                                                    <span>@s</span>
                                                }

                                            }
                                            else
                                            {
                                                if (item.tblTinNhan.NoiDung.Length >= 20)
                                                {
                                                    <span>@item.tblTinNhan.NoiDung.Substring(0, 17)...</span>
                                                }
                                                else
                                                {
                                                    @item.tblTinNhan.NoiDung
                                                }
                                            }
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </a>
                </li>
            }
        }
    }

</ul>
